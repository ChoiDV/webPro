DROP TABLE MEMBER CASCADE CONSTRAINTS;
CREATE TABLE MEMBER(
	CUSTNO NUMBER(5) PRIMARY KEY,
	CUSTNAME VARCHAR2(20),
	PHONE    VARCHAR2(20),
	ADDRESS VARCHAR2(60),
	JOINDATE DATE,
	GRADE    CHAR(1),
	CITY     CHAR(2)	
);
DROP SEQUENCE MEMBER_SQ;
CREATE SEQUENCE MEMBER_SQ START WITH 1001 MAXVALUE 99999 NOCACHE NOCYCLE;
INSERT INTO MEMBER
	VALUES (MEMBER_SQ.NEXTVAL, '홍길동','010-1111-2222','서울 동대문구', TO_DATE('20220702','YYYYMMDD'), 'A','01');
INSERT INTO MEMBER 
	VALUES (MEMBER_SQ.NEXTVAL, '신길동','010-1111-3333','서울 강남구', TO_DATE('20220601','YYYYMMDD'), 'B','01');
INSERT INTO MEMBER
	VALUES (MEMBER_SQ.NEXTVAL, '김길동','010-1111-4444','경기도 안양시', TO_DATE('20220501','YYYYMMDD'), 'B','30');
INSERT INTO MEMBER
	VALUES (MEMBER_SQ.NEXTVAL, '유길동','010-1111-5555','경기도 의정부시', TO_DATE('20220703','YYYYMMDD'), 'A','30');
INSERT INTO MEMBER
	VALUES (MEMBER_SQ.NEXTVAL, '정길동','010-1111-6666','서울시 용산구', TO_DATE('20220703','YYYYMMDD'), 'B','60');

SELECT * FROM MEMBER;
DROP TABLE MEMBERLEVEL;
CREATE TABLE MEMBERLEVEL(
	GRADE    CHAR(1) PRIMARY KEY,
	GRADENAME VARCHAR2(10)
);
INSERT INTO MEMBERLEVEL VALUES ('A','VIP');
INSERT INTO MEMBERLEVEL VALUES ('B','일반');
INSERT INTO MEMBERLEVEL VALUES ('C','직원');
SELECT * FROM MEMBERLEVEL;
DROP TABLE MONEY;
CREATE TABLE MONEY(
    SALENO NUMBER(8) PRIMARY KEY,
	CUSTNO NUMBER(5) REFERENCES MEMBER(CUSTNO) NOT NULL,	
	COST NUMBER(8),
	AMOUNT NUMBER(4),
	PRICE  NUMBER(8),
	PCODE  VARCHAR2(4),
	SDATE  DATE
);
INSERT INTO MONEY 
	VALUES (202201, 1001, 100, 20, 100*20, 'A01', TO_DATE('20220701','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202202, 1001, 150, 20, 150*20, 'A02', TO_DATE('20220701','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202203, 1002, 200, 10, 200*10, 'A03', TO_DATE('20220701','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202204, 1003, 100, 5, 100*5, 'A01', TO_DATE('20220701','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202205, 1004, 100, 9, 100*9, 'A01', TO_DATE('20220702','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202206, 1003, 150, 6, 150*6, 'A02', TO_DATE('20220703','YYYYMMDD'));
INSERT INTO MONEY 
	VALUES (202207, 1001, 200, 2, 100*2, 'A03', TO_DATE('20220704','YYYYMMDD'));

	
SELECT * FROM MONEY;


-- MemberDao
-- memberCustno
SELECT MAX(CUSTNO)+1 CUSTNO FROM MEMBER;
-- memberList
SELECT CUSTNO, CUSTNAME, PHONE, ADDRESS, to_char(JOINDATE,'YYYY-MM-DD') joindate, GRADE, CITY
	FROM MEMBER;
-- join
INSERT INTO MEMBER (custno, custname, phone, address, joindate, grade, city)
	VALUES (MEMBER_SQ.NEXTVAL, '김행복','010-1111-2222','서울 서초구', TO_DATE('20220726','YYYYMMDD'), 'A','01');
-- getMember
SELECT CUSTNO, CUSTNAME, PHONE, ADDRESS, to_char(JOINDATE,'YYYYMMDD') joindate, grade, CITY 
    FROM  MEMBER  WHERE CUSTNO=1001;
-- update
UPDATE MEMBER SET CUSTNAME = '홍낄똥',
				PHONE='010-1111-2222',
				ADDRESS='서울 강남구',
				JOINDATE=TO_DATE('20220702','YYYYMMDD'),
				GRADE = 'A',
				CITY = '01'
			WHERE CUSTNO = 1001;

-- SalesDao
SELECT CUSTNO, SUM(PRICE) FROM MONEY group BY CUSTNO; -- 1단계
-- salesList
SELECT M.CUSTNO, CUSTNAME, GRADENAME, PRICE
	FROM MEMBER M, MEMBERLEVEL ML,
		(SELECT CUSTNO, SUM(PRICE) PRICE FROM MONEY GROUP BY CUSTNO) SALES
	WHERE M.CUSTNO = SALES.CUSTNO AND M.GRADE=ML.GRADE
	ORDER BY PRICE DESC; 
SELECT CUSTNO, CUSTNAME, GRADENAME, (SELECT SUM(PRICE) FROM MONEY WHERE CUSTNO=M.CUSTNO) PRICE
	FROM MEMBER M, MEMBERLEVEL ML
	WHERE ML.GRADE=M.GRADE AND (SELECT SUM(PRICE) FROM MONEY WHERE CUSTNO=M.CUSTNO) IS NOT NULL
	ORDER BY PRICE DESC; -- 이 QUERY도 되나 위에 것을 씀
    
-- HOTPRODUCTLIST
SELECT PCODE, SUM(PRICE) PRICE FROM MONEY GROUP BY PCODE ORDER BY PRICE DESC;

COMMIT;